# with 構文

### 一般的な Python の with 構文

#### 意味：コンテキストマネージャ（Context Manager） を使う構文

with は「リソースの確保と解放」を自動で行うための構文  
ex.

```python
with open("example.txt", "r") as f:
    data = f.read()
# ← ここを出た時点で f.close() が自動で呼ばれる

```

- open() で開いたファイルは、使い終わったら close() しないとファイルディスクリプタ（OS リソース）が残り続ける
- 例外が発生しても確実に閉じる保証が欲しい → with が登場

##### with 実際の 2 つのメソッド

| メソッド      | 役割                                                                  |
| ------------- | --------------------------------------------------------------------- |
| `__enter__()` | リソースを準備し、`as` の右側に返す                                   |
| `__exit__()`  | `with` ブロックを抜けたときにクリーンアップ（例外があっても必ず実行） |

### コンテキストマネージャ

- 「ある処理の**前後で必ず実行したいコード**を、自動的に管理してくれるオブジェクト」のこと
- Python では、`__enter__()` と` __exit__()` という 2 つの特別なメソッドを持つクラス（またはオブジェクト）が、コンテキストマネージャ
- あるリソースを開いて使って閉じるまでを自動的に管理してくれる仕組み

### socket.socket

- コンテキストマネージャに対応している
- 内部ではファイルオブジェクトと同じように、`__enter__()` と` __exit__()` が定義されている
- したがって、with ブロックを抜けると： - 通常終了でも - 例外発生でも
  → 必ず s.close() が呼ばれる。
  これにより、接続リソースが OS に正しく返却される。
