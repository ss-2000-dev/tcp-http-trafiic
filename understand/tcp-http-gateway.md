# TODO: æœªæ•´ç† expressProxy.js

ç´ æ™´ã‚‰ã—ã„ã§ã™ ğŸ‘
ã“ã® `expressProxy.js` ã¯ã€**HTTP ã¨ TCP ã®æ©‹æ¸¡ã—ï¼ˆãƒ—ãƒ­ã‚­ã‚·ï¼‰**ã‚’ã™ã‚‹ã‚µãƒ¼ãƒã§ã™ã€‚
è¡¨é¢ä¸Šã¯ã€Œæ™®é€šã® Express ã‚µãƒ¼ãƒã€ã§ã™ãŒã€è£å´ã§ã¯ `net` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ TCP é€šä¿¡ã‚‚è¡Œã£ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã‚’ç†è§£ã™ã‚‹ã«ã¯ã€HTTP â†’ Base64 â†’ TCP ã®æµã‚Œã‚’ä¸€æ­©ãšã¤è¿½ã†ã®ãŒåŠ¹æœçš„ã§ã™ã€‚

---

## ğŸ§© 1. å…¨ä½“åƒï¼šã“ã®ã‚³ãƒ¼ãƒ‰ãŒã‚„ã£ã¦ã„ã‚‹ã“ã¨

ã–ã£ãã‚Šè¨€ã†ã¨ï¼š

```
Python ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
   â†“ HTTP POST (Base64åŒ–ãƒ‡ãƒ¼ã‚¿)
Expressã‚µãƒ¼ãƒ (ã“ã®ã‚³ãƒ¼ãƒ‰)
   â†“ TCP (Base64åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾é€ä¿¡)
TCPã‚µãƒ¼ãƒ (Pythonãªã©)
   â†‘ å¿œç­”(Base64)
Expressã‚µãƒ¼ãƒ
   â†‘ Base64ã‚’UTF-8ã«æˆ»ã—ã¦å†åŠ å·¥
   â†“ HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹(Base64åŒ–)
Pythonã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
```

ã¤ã¾ã‚Šï¼š

> ã€ŒHTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦ã€ãã®ãƒ‡ãƒ¼ã‚¿ã‚’ TCP ã§åˆ¥ã‚µãƒ¼ãƒã¸ä¸­ç¶™ã—ã€è¿”ã£ã¦ããŸå¿œç­”ã‚’ HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã™ã€
> ã¨ã„ã† **HTTPâ†”TCP ãƒ–ãƒªãƒƒã‚¸** ã§ã™ã€‚

---

## ğŸ§  2. Express éƒ¨åˆ†ã®è§£èª¬

```js
app.post(
  "/upload",
  express.raw({ type: "application/octet-stream", limit: "50mb" }),
  async (req, res) => { ... }
);
```

### âœ… `express.raw()` ã¨ã¯

é€šå¸¸ã€Express ã¯ JSON ã‚„ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«ãƒ‘ãƒ¼ã‚¹ã—ã¾ã™ã€‚
ã—ã‹ã—ã€ä»Šå›ã¯ã€Œãƒã‚¤ãƒŠãƒªï¼ˆBase64 æ–‡å­—åˆ—ã‚’å«ã‚€ï¼‰ã€ã‚’é€ã‚‹ãŸã‚ã€
`express.raw()` ã‚’ä½¿ã£ã¦ **ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ Buffer ã®ã¾ã¾å–å¾—** ã—ã¾ã™ã€‚

```js
const b64Buffer = req.body;
console.log(typeof b64Buffer); // object (Buffer)
```

ã“ã“ã§å–å¾—ã•ã‚Œã‚‹ `b64Buffer` ã¯ã€Base64 æ–‡å­—åˆ—ï¼ˆASCII ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã®ãƒã‚¤ãƒŠãƒªè¡¨ç¾ã§ã™ã€‚

---

## ğŸ” 3. Base64 ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã¨å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å‡¦ç†

```js
const b64String = b64Buffer.toString("ascii");
const decoded = Buffer.from(b64String, "base64").toString("utf8");
```

### ã‚¹ãƒ†ãƒƒãƒ—è§£èª¬ï¼š

1. `b64Buffer` â†’ ASCII æ–‡å­—åˆ—ã¸ (`toString("ascii")`)
   â†’ ã“ã‚Œã§ `"SGVsbG8gd29ybGQh"` ã®ã‚ˆã†ãª Base64 ãƒ†ã‚­ã‚¹ãƒˆã«ãªã‚‹ã€‚
2. `Buffer.from(..., "base64")` ã§ **Base64 ãƒ‡ã‚³ãƒ¼ãƒ‰**
   â†’ UTF-8 æ–‡å­—åˆ— `"Hello world!"` ã«ãªã‚‹ã€‚

ãã®ã‚ã¨ï¼š

```js
const message = decoded + ", node proxy server!";
```

ã¨è¿½è¨˜ã—ã€

```js
const messageB64 = Buffer.from(message, "utf8").toString("base64");
```

ã§å†ã³ Base64 ã«æˆ»ã—ã¾ã™ã€‚
TCP å´ã¯ã“ã® Base64 æ–‡å­—åˆ—ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

---

## ğŸŒ 4. TCP é€šä¿¡éƒ¨åˆ†ï¼ˆ`net` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰

ã“ã“ãŒä¸€ç•ªã®è‚ã§ã™ã€‚

```js
const responseB64 = await new Promise((resolve, reject) => {
  const client = new net.Socket();
  let responseChunks = [];

  client.connect(TCP_TARGET_PORT, TCP_TARGET_HOST, () => {
    client.write(messageB64);
  });
```

### `net.Socket` ã®åŸºæœ¬å‹•ä½œ

- `connect(port, host, callback)` ã§ã‚µãƒ¼ãƒã¸æ¥ç¶šã€‚
- `write(data)` ã§é€ä¿¡ã€‚
- `on("data")` ã§å—ä¿¡ã€‚
- `on("end")` ã§é€šä¿¡çµ‚äº†ã€‚

ã¤ã¾ã‚Šã€ã“ã®éƒ¨åˆ†ã¯ **éåŒæœŸ TCP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ** ã‚’ Promise ã§ãƒ©ãƒƒãƒ—ã—ã¦ã€
ã€ŒTCP é€šä¿¡ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…ã¤ã€ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã‚ã‘ã§ã™ã€‚

---

## ğŸ’¾ 5. TCP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å—ä¿¡ã¨å‡¦ç†

```js
client.on("data", (data) => {
  responseChunks.push(data);
});

client.on("end", () => {
  const fullResponse = Buffer.concat(responseChunks);
  const decodedResponse = Buffer.from(fullResponse.toString("ascii"), "base64").toString("utf8");
```

ã“ã“ã§ã‚‚ï¼š

1. `data` ã‚¤ãƒ™ãƒ³ãƒˆã§å—ã‘å–ã‚‹ãŸã³ã« `responseChunks` ã«è“„ç©ã€‚
2. `end` ã‚¤ãƒ™ãƒ³ãƒˆã§å—ä¿¡å®Œäº†ã‚’æ¤œçŸ¥ã€‚
3. å…¨ãƒã‚¤ãƒˆã‚’çµåˆ (`Buffer.concat`)ã€‚
4. Base64 â†’ UTF-8 ã¸æˆ»ã™ã€‚

ãã®ã‚ã¨è¿½è¨˜ã—ã¦å†ã³ Base64 åŒ–ï¼š

```js
const modifiedMessage = decodedResponse + ", node proxy server!";
const modifiedB64 = Buffer.from(modifiedMessage, "utf8").toString("base64");
resolve(Buffer.from(modifiedB64, "ascii"));
```

---

## ğŸ“¤ 6. HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™

```js
res
  .status(200)
  .set("Content-Type", "application/octet-stream")
  .send(responseB64);
```

ã¤ã¾ã‚Šã€ã€ŒTCP ã‚µãƒ¼ãƒã‹ã‚‰ã®å¿œç­”ï¼ˆBase64 æ–‡å­—åˆ—ï¼‰ã€ã‚’ãã®ã¾ã¾ **HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹** ã¨ã—ã¦è¿”ã—ã¦ã„ã¾ã™ã€‚

---

## âš™ï¸ 7. æœ€å¾Œã«ã¾ã¨ã‚ã‚‹ã¨

| å‡¦ç†æ®µéš         | ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼        | å†…å®¹ä¾‹                     |
| ---------------- | ------------------- | -------------------------- |
| Python â†’ Express | HTTP + Base64       | `"SGVsbG8gd29ybGQh"`       |
| Express å†…éƒ¨     | Buffer (ASCII)      | `<Buffer 53 47 56 73 ...>` |
| Express â†’ TCP    | Base64 ãƒ†ã‚­ã‚¹ãƒˆé€ä¿¡ | `"SGVsbG8gd29ybGQh"`       |
| TCP â†’ Express    | Base64 å¿œç­”         | `"V2VsY29tZSE="`           |
| Express â†’ Python | HTTP + Base64       | `"V2VsY29tZSE="`           |

---

## ğŸ’¡ 8. è£œè¶³ï¼šPromise ãƒ©ãƒƒãƒ—ã®æ„ç¾©

`net.Socket` ã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ãªã®ã§ã€æ™®é€šã«æ›¸ãã¨ã€Œcallback åœ°ç„ã€ã«ãªã‚Šã¾ã™ã€‚
ãã‚Œã‚’ `Promise` ã«åŒ…ã‚“ã§ï¼š

```js
await new Promise((resolve, reject) => { ... })
```

ã¨æ›¸ãã“ã¨ã§ã€**TCP é€šä¿¡ã®å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™**ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ”§ 9. æ”¹å–„ã®ä½™åœ°

ç¾çŠ¶ã¯å‹•ä½œç¢ºèªå‘ã‘ã¨ã—ã¦è‰¯ã„ã§ã™ãŒã€å®Ÿé‹ç”¨ã§ã¯ï¼š

- TCP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ `client.destroy()` ã§æ˜ç¤ºçš„ã«é–‰ã˜ã‚‹
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (`client.setTimeout()`) ã‚’è¨­ã‘ã‚‹
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†å ´åˆã¯ `stream` ã§å‡¦ç†
  ãªã©ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

---

ã‚‚ã—ã‚ˆã‘ã‚Œã°æ¬¡ã¯ã€ã“ã® TCP é€šä¿¡éƒ¨åˆ†ã ã‘ã‚’æŠœãå‡ºã—ã¦
ã€ŒNode.js ã§ TCP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã ã‘å‹•ã‹ã™ã€ä¾‹ã‚’ç¤ºã—ã¦ã€æ®µéšçš„ã«ç†è§£ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ã‹ï¼Ÿ

### å‚è€ƒ

- https://nodejs.org/api/net.html#class-netsocket

---

# æ·±æ˜ã‚Š 1

## Promise ã§åŒ…ã‚“ã§ã„ã‚‹ç†ç”±

```js
const responseB64 = await new Promise((resolve, reject) => {
  ...
});
```

ã“ã“ã§ã‚„ã£ã¦ã„ã‚‹ã®ã¯ã€**éåŒæœŸã® TCP é€šä¿¡ã‚’ã€Œawait ã§ãã‚‹å½¢å¼ã€ã«ã—ã¦ã„ã‚‹**ã“ã¨ã§ã™ã€‚

### Node.js ã®ã€ŒéåŒæœŸã€ã¨ã¯

Node.js ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ï¼ˆ`net.Socket`ï¼‰ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã§å‹•ãã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãŒå±Šã„ãŸã‚‰ `data` ã‚¤ãƒ™ãƒ³ãƒˆã€é€šä¿¡ãŒçµ‚äº†ã—ãŸã‚‰ `end` ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ã¾ã™ã€‚

ã“ã‚Œã¯åŒæœŸçš„ã«ã¯æ›¸ã‘ã¾ã›ã‚“ï¼ˆ`recv()` ã®ã‚ˆã†ã«ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã—ãªã„ï¼‰ã®ã§ã€
ã€ŒPromiseã€ã‚’ä½¿ã£ã¦ã€Œå®Œäº†ã—ãŸã‚‰çµæœã‚’è¿”ã™ã€ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

### ãªãœ Promise ã§åŒ…ã‚€ï¼Ÿ

Promise ã¯ã€ŒéåŒæœŸå‡¦ç†ã®çµæœã‚’ã²ã¨ã¤ã®å€¤ã¨ã—ã¦æ‰±ã†ã€ãŸã‚ã®ä»•çµ„ã¿ã€‚
`await`ã‚’ä½¿ã£ã¦ä¸€è¦‹åŒæœŸçš„ã«æ›¸ã‘ã¾ã™ã€‚

```js
await new Promise((resolve, reject) => { ... })
```

ã“ã‚Œã«ã‚ˆã‚Šã€TCP é€šä¿¡ã®å®Œäº†ï¼ˆ`client.on("end")`ã§ resolveï¼‰ã¾ã§å¾…ã¦ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

## Promise å…¨ä½“ã®æ„å‘³

ä¸Šè¨˜ã™ã¹ã¦ã‚’ã¾ã¨ã‚ã‚‹ã¨ã€ã“ã® Promise ã¯ã€Œ**TCP é€šä¿¡ä¸€å¾€å¾©**ã€ã‚’è¡¨ã™

çµæœã¯ `resolve()` ã§è¿”ã•ã‚Œã€å‘¼ã³å‡ºã—å…ƒã§ `await` ã—ã¦å—ã‘å–ã‚Œã¾ã™ï¼š

```js
const responseB64 = await new Promise((resolve, reject) => { ... });
```

ã“ã‚Œã«ã‚ˆã‚Šã€**éåŒæœŸ TCP é€šä¿¡ã‚’ã€ŒåŒæœŸçš„ãªæµã‚Œã§ã€æ‰±ãˆã‚‹**ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

## è£œè¶³ï¼šNode.js ã«ãŠã‘ã‚‹ã€ŒéåŒæœŸ I/O ãƒ¢ãƒ‡ãƒ«ã€

Node.js ã¯ã€Œã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã€ã«ã‚ˆã£ã¦ã™ã¹ã¦ã® I/Oï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰ã‚’éåŒæœŸã«æ‰±ã„ã¾ã™ã€‚
ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å¢—ã‚„ã™ã®ã§ã¯ãªãã€**ã‚¤ãƒ™ãƒ³ãƒˆã¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å‡¦ç†ã‚’æŒã**ã€‚

Promise + async/await ã®æ§‹æ–‡ã¯ã€ã“ã‚Œã‚’ã€Œè¦‹ãŸç›®åŒæœŸçš„ã«ã€æ›¸ããŸã‚ã®ä»•çµ„ã¿ã§ã™ã€‚

# TODO: æ·±æ˜ã‚Š 2

ã¨ã¦ã‚‚è‰¯ã„è³ªå•ã§ã™ã€‚
ã“ã®ä¸€é€£ã®æ¦‚å¿µï¼ˆéåŒæœŸãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ãƒ»ã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰ã¯ Node.js ã®å¿ƒè‡“éƒ¨ã«é–¢ã‚ã‚‹é‡è¦ãªéƒ¨åˆ†ã§ã™ã€‚
ã“ã“ã§ã¯å°‚é–€ç”¨èªã‚’ã§ãã‚‹ã ã‘å™›ã¿ç •ããªãŒã‚‰ã€**ç¾å®Ÿä¸–ç•Œã®æ¯”å–©**ã‚‚äº¤ãˆã¦èª¬æ˜ã—ã¾ã™ã€‚

---

## ğŸ§  ã¾ãšå…¨ä½“åƒ

Node.js ã¯ã€Œ**éåŒæœŸãƒ»ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰**ã€ã¨ã„ã†ç‰¹å¾´ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
ã¤ã¾ã‚Šã€ã€ŒåŒæ™‚ã«è¤‡æ•°ã®ã“ã¨ã‚’ã‚„ã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€ã‘ã‚Œã©ã€å®Ÿéš›ã«ã¯**1 ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§é †ç•ªã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†**ã—ã¦ã„ã‚‹ã®ã§ã™ã€‚

---

## 1ï¸âƒ£ éåŒæœŸã¨ã¯ï¼ˆNode.js ã«ãŠã‘ã‚‹ï¼‰

**éåŒæœŸï¼ˆasynchronousï¼‰**ã¨ã¯ã€ã€Œå¾…ãŸãšã«æ¬¡ã®å‡¦ç†ã«é€²ã‚€ã€ã“ã¨ã§ã™ã€‚

### ğŸ’¬ ä¾‹ï¼š

```js
fs.readFile("file.txt", (err, data) => {
  console.log("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ï¼");
});
console.log("æ¬¡ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™");
```

ã“ã®å ´åˆï¼š

- `readFile()` ã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚’ OS ã«ä¾é ¼ã€ã—ã¦ã™ãæˆ»ã£ã¦ãã¾ã™ï¼ˆï¼ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
- ã€Œæ¬¡ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€ãŒå…ˆã«å‡ºåŠ›ã•ã‚Œã¾ã™
- èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰ OS ã‹ã‚‰ã€Œçµ‚ã‚ã£ãŸã‚ˆã€ã¨ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ãŒæ¥ã¦ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã¾ã™

ğŸ‘‰ **Node.js ã§ã¯ã€ŒI/Oï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰ã€ã‚’å¾…ãŸãšã«é€²ã‚ã‚‹**ã®ãŒéåŒæœŸã§ã™ã€‚

---

## 2ï¸âƒ£ åŒæœŸã¨éåŒæœŸã®é•ã„

| ç¨®é¡       | ã‚¤ãƒ¡ãƒ¼ã‚¸                           | å‡¦ç†ã®æµã‚Œ                                            |
| ---------- | ---------------------------------- | ----------------------------------------------------- |
| åŒæœŸå‡¦ç†   | ã€Œ1 äººã§é †ç•ªã«å…¨éƒ¨ã‚„ã‚‹ã€           | A ãŒçµ‚ã‚ã‚‹ã¾ã§ B ã‚’å¾…ã¤                               |
| éåŒæœŸå‡¦ç† | ã€Œä»–ã®äººã«é ¼ã‚“ã§ã€è‡ªåˆ†ã¯æ¬¡ã«é€²ã‚€ã€ | A ã‚’é ¼ã‚“ã§ B ã‚’ã™ãå§‹ã‚ã‚‹ï¼ˆA ãŒçµ‚ã‚ã£ãŸã‚‰é€£çµ¡ãŒæ¥ã‚‹ï¼‰ |

### ğŸ§â€â™‚ï¸ ä¾‹ãˆè©±ï¼š

ã‚ãªãŸãŒã‚«ãƒ•ã‚§ã§ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’æ³¨æ–‡ã™ã‚‹å ´åˆï¼š

- **åŒæœŸ**ï¼š
  ãƒãƒªã‚¹ã‚¿ãŒã‚³ãƒ¼ãƒ’ãƒ¼ã‚’ä½œã‚Šçµ‚ãˆã‚‹ã¾ã§ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§å¾…ã¤ï¼ˆã‚ãªãŸã¯ä½•ã‚‚ã§ããªã„ï¼‰

- **éåŒæœŸ**ï¼š
  ãƒãƒªã‚¹ã‚¿ã«æ³¨æ–‡ã—ã¦å¸­ã«æˆ»ã‚Šã€ãƒ‘ã‚½ã‚³ãƒ³ã‚’é–‹ã„ã¦ä½œæ¥­ã€‚
  ã‚³ãƒ¼ãƒ’ãƒ¼ãŒã§ããŸã‚‰å‘¼ã°ã‚Œã‚‹ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰â†’ å–ã‚Šã«è¡Œãï¼ˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰

Node.js ã¯ã“ã®ã€Œå¾Œã§å‘¼ã°ã‚Œã‚‹ã€ä»•çµ„ã¿ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

---

## 3ï¸âƒ£ ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã¨ã¯

**ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ï¼ˆevent loopï¼‰**ã¨ã¯ã€Node.js ãŒã€Œã‚¤ãƒ™ãƒ³ãƒˆã‚’é †ç•ªã«å‡¦ç†ã™ã‚‹ä»•çµ„ã¿ã€ã§ã™ã€‚

Node.js ã¯å®Ÿéš›ã«ã¯ã€Œç„¡é™ãƒ«ãƒ¼ãƒ—ã€ã§å‹•ã„ã¦ã„ã¾ã™ï¼š

```
while (ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå‹•ã„ã¦ã„ã‚‹) {
  ã‚‚ã—å®Œäº†ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Œã° â†’ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œ
  ä½•ã‚‚ãªã‘ã‚Œã°å¾…æ©Ÿ
}
```

ã¤ã¾ã‚Šã€Œãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ã€ã€Œãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¿œç­”ã‚ã‚Šã€ã¨ã„ã£ãŸã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹ãŸã³ã«ã€ãã®å¯¾å¿œã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒã‚­ãƒ¥ãƒ¼ï¼ˆå¾…ã¡è¡Œåˆ—ï¼‰ã«å…¥ã‚Šã€é †ç•ªã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚

---

## 4ï¸âƒ£ ã€Œã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«ã‚ˆã£ã¦ã™ã¹ã¦ã® I/O ã‚’éåŒæœŸã«æ‰±ã†ã€ã¨ã¯

æ™®é€šã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚€ã€ã‚„ã€Œãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ã‚’å¾…ã¤ã€ã¨ãã«æ­¢ã¾ã‚Šã¾ã™ï¼ˆåŒæœŸçš„ï¼‰ã€‚

ã—ã‹ã— Node.js ã§ã¯ï¼š

- ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ã¯ OS ã«ä»»ã›ã‚‹
- Node.js ã¯ã€Œã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã€ã§ä»–ã®å‡¦ç†ã‚’ç¶šã‘ã‚‹
- I/O ãŒçµ‚ã‚ã‚‹ã¨ OS ãŒã€Œçµ‚ã‚ã£ãŸã‚ˆã€ã¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿”ã™ â†’ Node.js ãŒãã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹

ğŸ‘‰ **å¾…ãŸãšã«ä»–ã®ä»•äº‹ã‚’ã§ãã‚‹**
ã“ã‚ŒãŒã€ŒI/O ã‚’éåŒæœŸã§æ‰±ã†ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚

---

## 5ï¸âƒ£ ã‚¹ãƒ¬ãƒƒãƒ‰ã¨ã¯

**ã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆthreadï¼‰**ã¨ã¯ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãŒã€ŒåŒæ™‚ã«å®Ÿè¡Œã§ãã‚‹å‡¦ç†ã®æµã‚Œã€ã®ã“ã¨ã§ã™ã€‚

- ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ï¼šè¤‡æ•°ã®å‡¦ç†ã‚’åŒæ™‚ã«ä¸¦åˆ—ã§å‹•ã‹ã™ï¼ˆä¾‹ï¼šJavaã€Python ã®ä¸€éƒ¨ï¼‰
- ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ï¼š1 æœ¬ã®æµã‚Œã§é †ç•ªã«å‡¦ç†ï¼ˆNode.jsï¼‰

ãŸã ã— Node.js ã‚‚å†…éƒ¨çš„ã«ã¯å®Œå…¨ãªã‚·ãƒ³ã‚°ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
C++ã§æ›¸ã‹ã‚ŒãŸ **libuv** ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã€OS ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦è£ã§ I/O å‡¦ç†ã‚’ä¸¦è¡Œã—ã¦æŒã„ã¦ã„ã¾ã™ã€‚
ã§ã‚‚ã€**ã‚ãªãŸãŒæ›¸ã JavaScript ã®ã‚³ãƒ¼ãƒ‰è‡ªä½“ã¯å¸¸ã« 1 æœ¬ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§å‹•ã**ã¨ã„ã†ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

---

## 6ï¸âƒ£ ã€Œã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å¢—ã‚„ã™ã®ã§ã¯ãªãã€ã‚¤ãƒ™ãƒ³ãƒˆã¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å‡¦ç†ã‚’æŒãã€ã¨ã¯

å¤šãã®è¨€èªã§ã¯ã€ŒåŒæ™‚ã«è¤‡æ•°ã®ä»•äº‹ã‚’ã•ã°ããŸã„ã€å ´åˆã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å¢—ã‚„ã—ã¾ã™ã€‚
ï¼ˆä¾‹ï¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹ï¼‰

ã§ã‚‚ãã‚Œã ã¨ï¼š

- ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹ã‚³ã‚¹ãƒˆãŒé«˜ã„
- ãƒ¡ãƒ¢ãƒªã‚’å¤šãä½¿ã†
- æ•°ä¸‡ã®æ¥ç¶šã‚’æ‰±ã†ã¨ãƒ‘ãƒ³ã‚¯ã™ã‚‹

Node.js ã¯ãã®ä»£ã‚ã‚Šã«ï¼š

- ã™ã¹ã¦ã® I/O ã‚’éåŒæœŸã§æŠ•ã’ã‚‹
- çµ‚ã‚ã£ãŸã‚‚ã®ã‹ã‚‰ã€Œã‚¤ãƒ™ãƒ³ãƒˆã€ã§é€šçŸ¥
- ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã§é †ç•ªã«å‡¦ç†

ã“ã‚Œã«ã‚ˆã‚Šã€**1 ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚‚æ•°ä¸‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åŠ¹ç‡çš„ã«æŒã‘ã‚‹**ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

---

## ğŸª„ ã¾ã¨ã‚

| æ¦‚å¿µ                   | æ„å‘³                                     | Node.js ã§ã®å‹•ã                               |
| ---------------------- | ---------------------------------------- | ---------------------------------------------- |
| éåŒæœŸ                 | å¾…ãŸãšã«æ¬¡ã®å‡¦ç†ã«é€²ã‚€                   | ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ I/O ã‚’ OS ã«ä»»ã›ã‚‹      |
| åŒæœŸ                   | å‡¦ç†ãŒçµ‚ã‚ã‚‹ã¾ã§æ­¢ã¾ã‚‹                   | ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å‡¦ç†ï¼ˆ`readFileSync`ãªã©ï¼‰         |
| ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—         | éåŒæœŸå‡¦ç†ã‚’é †ç•ªã«æŒãä»•çµ„ã¿             | å®Œäº†ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‡¦ç†           |
| ã‚¹ãƒ¬ãƒƒãƒ‰               | åŒæ™‚ã«å‹•ãå‡¦ç†ã®å˜ä½                     | JS ã¯ 1 ã‚¹ãƒ¬ãƒƒãƒ‰ã€I/O ã¯è£ã§ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«åˆ©ç”¨ |
| ã‚¤ãƒ™ãƒ³ãƒˆï¼‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ | éåŒæœŸå‡¦ç†ã‚’ã‚¹ãƒ¬ãƒƒãƒ‰å¢—ã‚„ã•ãšã«ã•ã°ãæ‰‹æ³• | Node.js ã®è¨­è¨ˆå“²å­¦                             |

---

ã‚‚ã—ã‚ˆã‘ã‚Œã°ã€æ¬¡ã«ã€Œã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚¿ã‚¤ãƒãƒ¼ãƒ»I/Oãƒ»ãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ï¼‰ã€ã®å†…éƒ¨æ§‹é€ ã‚‚å›³è§£ã§èª¬æ˜ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ
ã“ã“ã‚’ç†è§£ã™ã‚‹ã¨ã€`setTimeout`, `Promise`, `process.nextTick` ã®é•ã„ãŒã‚¯ãƒªã‚¢ã«ãªã‚Šã¾ã™ã€‚

# æ·±æ˜ã‚Š 3

ã‚ã¡ã‚ƒãã¡ã‚ƒè‰¯ã„è³ªå•ã§ã™ã€‚ğŸ‘
Node.js ã®éåŒæœŸå‡¦ç†ã‚„ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®æµã‚Œã¯ã€**é ­ã§ã¯ç†è§£ã—ã¦ã‚‚ã€Œè¦‹ãˆãªã„ä¸–ç•Œã€**ãªã®ã§ã€
çŸ¢å°ï¼ˆâ†’ï¼‰ã‚’ä½¿ã£ã¦ã€Œãƒ‡ãƒ¼ã‚¿ã¨åˆ¶å¾¡ã®æµã‚Œã€ã‚’**è¦–è¦šçš„ã«**æ•´ç†ã™ã‚‹ã®ãŒã¨ã¦ã‚‚åŠ¹æœçš„ã§ã™ã€‚

---

ã§ã¯ã€ä¾‹ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã‚’æƒ³å®šã—ã¾ã—ã‚‡ã†ï¼š

- Express ã‚µãƒ¼ãƒãŒ `/send` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ POST ã‚’å—ã‘å–ã‚‹
- Node.js ãŒ TCP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œã£ã¦ã€åˆ¥ã®ã‚µãƒ¼ãƒã¸é€ä¿¡ã™ã‚‹
- TCP ã‚µãƒ¼ãƒã‹ã‚‰å¿œç­”ã‚’å—ã‘å–ã‚Šã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã™

ã“ã‚Œã‚’ Node.js å†…éƒ¨ã®å‹•ãã¨ã—ã¦å›³è§£ã—ã¾ã™ ğŸ‘‡

---

## ğŸ§­ å…¨ä½“ã®æµã‚Œï¼ˆçŸ¢å°ä»˜ãï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ POST /send (HTTP)
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Express (Node.js) HTTPå±¤        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ app.post('/send', handler) ãŒåå¿œ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                  â”‚
â”‚     (1) ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡ â†’ Node.jsã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ãŒæ¤œçŸ¥
â”‚                  â”‚
â”‚                  â–¼
â”‚     handlerå†…ã§TCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
â”‚     socket = net.createConnection()
â”‚                  â”‚
â”‚     (2) OSã¸æ¥ç¶šè¦æ±‚ â†’ Node.jsã¯I/Oã‚’libuvçµŒç”±ã§OSã«ä»»ã›ã‚‹
â”‚                  â”‚
â”‚                  â–¼
â”‚     ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã¯ä»–ã®å‡¦ç†ã‚’ç¶™ç¶šï¼‰
â”‚                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚ OSã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤ãŒæ¥ç¶šå®Œäº†ã‚’é€šçŸ¥ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                   â”‚
â”‚     (3) Node.jsãŒã€Œconnectã‚¤ãƒ™ãƒ³ãƒˆã€ã‚’æ¤œçŸ¥
â”‚                   â”‚
â”‚                   â–¼
â”‚     socket.write(data) ã§é€ä¿¡ï¼ˆéåŒæœŸI/Oï¼‰
â”‚                   â”‚
â”‚     (4) OSãŒé€ä¿¡å®Œäº†ã‚’é€šçŸ¥ â†’ ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ãŒwriteå®Œäº†ã‚’å‡¦ç†
â”‚                   â”‚
â”‚                   â–¼
â”‚     (5) TCPã‚µãƒ¼ãƒã‹ã‚‰ã®è¿”ä¿¡ã‚’OSãŒå—ä¿¡
â”‚                   â”‚
â”‚                   â–¼
â”‚     Node.jsã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ãŒã€Œdataã‚¤ãƒ™ãƒ³ãƒˆã€ã‚’ç™ºç«
â”‚                   â”‚
â”‚                   â–¼
â”‚     handlerå†…ã® socket.on('data', ...) ãŒå®Ÿè¡Œ
â”‚                   â”‚
â”‚                   â–¼
â”‚     res.send() ã§HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
â”‚                   â”‚
â”‚                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© ã‚‚ã†å°‘ã—å…·ä½“çš„ãªã€ŒNode.js å†…éƒ¨æ§‹é€ ã€è¦–ç‚¹

Node.js ã®ä¸­ã§ã¯ã€ã–ã£ãã‚Šä»¥ä¸‹ã® 3 å±¤ãŒé€£æºã—ã¦ã„ã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   JavaScriptå±¤ï¼ˆã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ï¼‰      â”‚
â”‚   â””â”€â”€ Express, TCP client, etc.     â”‚
â”‚         â†“ ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆon, callbackï¼‰ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Node.js Core (libuv) å±¤           â”‚
â”‚   â””â”€â”€ ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—, ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«  â”‚
â”‚         â†“ éåŒæœŸI/Oä¾é ¼ï¼ˆOSã¸æ¸¡ã™ï¼‰   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   OS ã‚«ãƒ¼ãƒãƒ«å±¤                      â”‚
â”‚   â””â”€â”€ ãƒ•ã‚¡ã‚¤ãƒ«/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å‡¦ç†, é€šçŸ¥ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸŒ€ å‡¦ç†ã‚µã‚¤ã‚¯ãƒ«

```
JSã‚³ãƒ¼ãƒ‰ (é€ä¿¡è¦æ±‚)
    â†“
libuv (I/Oè¦æ±‚ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ )
    â†“
OS (æ¥ç¶š/é€ä¿¡/å—ä¿¡)
    â†“
å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’libuvã¸é€šçŸ¥
    â†“
libuv â†’ ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã§callbackå®Ÿè¡Œ
    â†“
JSã‚³ãƒ¼ãƒ‰å†…ã® on('data') ã‚„ res.send() ãŒå‘¼ã°ã‚Œã‚‹
```

---

## ğŸ§® å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã§è¦‹ã‚‹æµã‚Œï¼ˆç°¡ç•¥ï¼‰

```js
// expressProxy.js
app.post("/send", (req, res) => {
  const client = net.createConnection({ host: HOST, port: PORT }, () => {
    client.write(req.body.message); // (2)
  });

  client.on("data", (data) => {
    // (5)
    res.send(data.toString()); // (6)
    client.destroy(); // æ¥ç¶šçµ‚äº†
  });
});
```

ã“ã® 1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãŠã‘ã‚‹ã€Œæ™‚é–“ã®æµã‚Œã€ã‚’è¡¨ã™ã¨ï¼š

```
HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡ â†’
  TCPæ¥ç¶šè¦æ±‚ â†’
    ï¼ˆå¾…ãŸãšã«Node.jsã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’å›ã™ï¼‰ â†’
      OSãŒæ¥ç¶šå®Œäº†é€šçŸ¥ â†’
        write â†’
          OSãŒé€ä¿¡å®Œäº† â†’
            ã‚µãƒ¼ãƒãŒè¿”ä¿¡ â†’
              dataã‚¤ãƒ™ãƒ³ãƒˆ â†’
                res.send() â†’
                  HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡å®Œäº†
```

---

## ğŸ’¡ ã¾ã¨ã‚ï¼ˆç›´æ„Ÿã§è¦šãˆã‚‹ï¼‰

| æ¦‚å¿µ           | ã‚¤ãƒ¡ãƒ¼ã‚¸             | Node.js ã§ã®å‹•ã                   |
| -------------- | -------------------- | ---------------------------------- |
| ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ— | èˆå°ç›£ç£             | å®Œäº†ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã®å‡ºç•ªã‚’é †ç•ªã«ç®¡ç† |
| éåŒæœŸ I/O     | OS ã«ä»•äº‹ã‚’é ¼ã‚€      | Node.js ã¯å¾…ãŸãšã«åˆ¥ã®ä»•äº‹ã‚’ç¶šã‘ã‚‹ |
| ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯   | å‡ºç•ªãŒæ¥ãŸã¨ãã®å°æœ¬ | ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã«å‘¼ã°ã‚Œã‚‹é–¢æ•°       |
| ã‚¹ãƒ¬ãƒƒãƒ‰       | ä¿³å„ªã®äººæ•°           | JS ã¯ 1 äººã€è£æ–¹(libuv)ã«æ•°äººã„ã‚‹  |
| ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•   | åˆå›³ã§å‹•ãä¸–ç•Œ       | ã™ã¹ã¦ã€Œçµ‚ã‚ã£ãŸã€ã€Œå±Šã„ãŸã€ã§å‹•ã |

---

ã‚‚ã—å¸Œæœ›ãŒã‚ã‚Œã°ã€ã“ã‚Œã‚’ã€ŒTCP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒã®ä¸¡æ–¹ã®æµã‚Œã€ã‚’
**åŒæ–¹å‘ã®çŸ¢å°**ä»˜ãã§å›³ç¤ºï¼ˆé€å—ä¿¡ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°å«ã‚€ï¼‰ã«ç™ºå±•ã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ã‚„ã£ã¦ã¿ã¾ã—ã‚‡ã†ã‹ï¼Ÿ

# æ·±æ˜ã‚Š 4

ç´ æ™´ã‚‰ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™ã€‚ğŸ‘
ã“ã“ã§ã¯ **Node.js ã® TCP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆexpressProxy.jsï¼‰** ã¨
**Python ã® TCP ã‚µãƒ¼ãƒï¼ˆä¾‹ãˆã° tcp_server.pyï¼‰** ãŒé€šä¿¡ã—ã¦ã„ã‚‹æ§˜å­ã‚’ã€
**é€ä¿¡ï¼ˆâ†’ï¼‰ãƒ»å¿œç­”ï¼ˆâ†ï¼‰ã‚’æ˜ç¤ºçš„ã«**ç¤ºã—ã¦ã€Node.js ã®å†…éƒ¨å‹•ãã‚‚å«ã‚ã¦èª¬æ˜ã—ã¾ã™ã€‚

---

## ğŸ§© å…¨ä½“æ§‹é€ ã‚¤ãƒ¡ãƒ¼ã‚¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Node.js å´ï¼ˆexpressProxy.jsï¼‰                     â”‚
â”‚  [HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦ TCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦å‹•ã]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
                          TCPé€šä¿¡çµŒè·¯
                                â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Python å´ï¼ˆtcp_server.pyï¼‰                       â”‚
â”‚        [TCPã‚µãƒ¼ãƒã¨ã—ã¦å¾…æ©Ÿã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš™ï¸ åŒæ–¹å‘ã®æµã‚Œï¼ˆè©³ç´°ï¼‰

ã“ã“ã§ã¯ã€`message = "Hello from Node Proxy!"` ã‚’é€ä¿¡ã—ã¦
ã‚µãƒ¼ãƒãŒ `"Hello from Python Server!"` ã‚’è¿”ã™ä¾‹ã§è§£èª¬ã—ã¾ã™ã€‚

```
ã€STEP 0ã€‘ExpressãŒHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
HTTP Client â†’ Expressã‚µãƒ¼ãƒï¼ˆ/uploadï¼‰
  â†“
Node.jsãŒPOSTã‚’æ¤œçŸ¥ â†’ handlerèµ·å‹•
  â†“
handlerå†…ã§ TCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ(net.Socket)
```

---

### ğŸ›°ï¸ é€šä¿¡ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆNode â‡„ Pythonï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Node.js å´ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ)                           â”‚
â”‚                expressProxy.js ã‹ã‚‰ TCPæ¥ç¶šé–‹å§‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ (1) connectè¦æ±‚ï¼ˆéåŒæœŸï¼‰
                â”‚-----------------------------------------â†’ OSã‚½ã‚±ãƒƒãƒˆå±¤
                â”‚                                           â”‚
                â”‚                                           â”‚
                â”‚â†------------------------------------------â”‚
                â”‚ (2) OSãŒæ¥ç¶šæˆåŠŸã‚’é€šçŸ¥ â†’ Node.jsã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—çµŒç”±
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ client.write("SGVsbG8gZnJvbSBOb2RlIFByb3h5IQ==")  // Base64é€ä¿¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ (3) OSãŒTCPãƒ‘ã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¦é€ä¿¡
                â”‚----------------------------------------â†’
                â”‚                                           â”‚
                â”‚                                           â–¼
                â”‚                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                  â”‚ Python TCPã‚µãƒ¼ãƒ (å—ä¿¡å´) â”‚
                â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                                           â”‚
                â”‚â†------------------------------------------â”‚
                â”‚ (4) Pythonã‚µãƒ¼ãƒãŒå—ä¿¡å®Œäº† â†’ ãƒ‡ã‚³ãƒ¼ãƒ‰ + å‡¦ç†
                â”‚                                           â”‚
                â”‚                                           â–¼
                â”‚                                  print("å—ä¿¡:", decoded)
                â”‚                                           â”‚
                â”‚                                           â”‚
                â”‚----------------------------------------â†’
                â”‚ (5) Pythonã‚µãƒ¼ãƒ â†’ Nodeã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸å¿œç­”é€ä¿¡
                â”‚       "SGVsbG8gZnJvbSBQeXRob24gU2VydmVyIQ=="
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node.js ãŒ data ã‚¤ãƒ™ãƒ³ãƒˆã§å—ä¿¡                              â”‚
â”‚ client.on("data", (chunk) => { responseChunks.push(chunk) }) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ (6) Pythonã‚µãƒ¼ãƒãŒé€ä¿¡çµ‚äº† â†’ FINé€ä¿¡
                â”‚â†------------------------------------------â”‚
                â”‚ Node.jsãŒ end ã‚¤ãƒ™ãƒ³ãƒˆæ¤œçŸ¥ â†’ Buffer.concat()
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fullResponse = Buffer.concat(responseChunks)               â”‚
â”‚ decoded = Buffer.from(fullResponse, 'base64').toString()   â”‚
â”‚ console.log("Pythonã®å¿œç­”:", decoded)                       â”‚
â”‚ client.destroy()  // æ¥ç¶šæ˜ç¤ºçš„ã«ã‚¯ãƒ­ãƒ¼ã‚º                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§  ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã¨éåŒæœŸã®å‹•ãï¼ˆNode.js å†…éƒ¨è¦–ç‚¹ï¼‰

```
(1) client.connect() ã‚’å‘¼ã³å‡ºã™
    â†’ libuv ãŒ OS ã«æ¥ç¶šä¾é ¼ã‚’å‡ºã™
    â†’ Node.js ã¯ã“ã“ã§ãƒ–ãƒ­ãƒƒã‚¯ã›ãš handler ã®å‡¦ç†ã‚’ç¶™ç¶š

(2) OS ãŒã€Œæ¥ç¶šæˆåŠŸã€ã‚’é€šçŸ¥ã™ã‚‹ã¨ã€libuv ãŒã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«ç™»éŒ²
    â†’ Node.js ãŒ client 'connect' ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«

(3) client.write() ã‚‚éåŒæœŸ
    â†’ OSãŒé€ä¿¡å®Œäº†ã‚’é€šçŸ¥ã—ãŸã‚‰ write ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã‚‹

(4) ã‚µãƒ¼ãƒã‹ã‚‰ã®å¿œç­”ãƒ‡ãƒ¼ã‚¿ãŒå±ŠããŸã³ã«
    â†’ libuv ãŒ 'data' ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
    â†’ ã‚ãªãŸã® client.on('data', ...) ãŒå®Ÿè¡Œã•ã‚Œã‚‹

(5) ã‚µãƒ¼ãƒãŒé€ä¿¡çµ‚äº†ï¼ˆFINï¼‰ã‚’é€ã‚‹ã¨
    â†’ 'end' ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ã¦å—ä¿¡å®Œäº†ãŒã‚ã‹ã‚‹

(6) ãã®å¾Œ res.send() ã§HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
```

---

## ğŸ“¡ Python å´ã®å†…éƒ¨çš„ãªæµã‚Œï¼ˆå‚è€ƒï¼‰

```python
with socket.socket(...) as s:
    s.bind(("127.0.0.1", 6000))
    s.listen(1)
    conn, addr = s.accept()        # Node.js ã‹ã‚‰ã®æ¥ç¶šã‚’å¾…ã¤
    data = conn.recv(4096)         # Node.js ã® write ã‚’å—ã‘å–ã‚‹
    decoded = base64.b64decode(data).decode("utf-8")
    print("å—ä¿¡:", decoded)
    response = "Hello from Python Server!"
    conn.sendall(base64.b64encode(response.encode("utf-8")))
```

---

## ğŸ§© ã¾ã¨ã‚ï¼šé€å—ä¿¡ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

```
Node.jsï¼ˆExpressï¼‰           Pythonã‚µãƒ¼ãƒ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
connect() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ accept()
write(Base64) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ recv() + decode()
                         â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ send(Base64)
on('data') event   â†â”€â”€â”€â”€â”€â”€â”˜
on('end') event    â†â”€â”€â”€â”€â”€â”€ï¼ˆã‚µãƒ¼ãƒãŒFINé€ä¿¡ï¼‰
destroy()          â”€â”€â”€â”€â”€â”€â†’ ã‚½ã‚±ãƒƒãƒˆå®Œå…¨ã‚¯ãƒ­ãƒ¼ã‚º
res.send()         â”€â”€â”€â”€â”€â”€â†’ HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸è¿”ä¿¡
```

---

ã“ã®ã‚ˆã†ã«ã€

- Node.js ã¯ **1 æœ¬ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¡å—ã‘**
- OS ã« I/O ã‚’ä¾é ¼ã—ã¦ **å®Œäº†é€šçŸ¥ã‚’ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã§å‡¦ç†**
- Python ã‚µãƒ¼ãƒã¯ **ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚° I/O ã§é †ã«å‡¦ç†**

ã¨ã„ã†éå¯¾ç§°æ§‹é€ ã§é€šä¿¡ã—ã¦ã„ã¾ã™ã€‚

---

å¸Œæœ›ãŒã‚ã‚Œã°ã€ã“ã‚Œã‚’ **ã€ŒExpress (HTTP) â†’ Node TCP â†’ Python TCP â†’ Node TCP â†’ Express HTTP Responseã€**
ã¨ã„ã† **5 æ®µéšã®æ™‚ç³»åˆ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ï¼ˆç¸¦æ–¹å‘ã®æ™‚é–“è»¸ã¤ãï¼‰** ã«ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ãã®å½¢ã§ã‚‚è¦‹ãŸã„ã§ã™ã‹ï¼Ÿ
